# Linux文件系统

文件系统是操作系统中负责管理持久数据的，就是管理磁盘中的数据。

**在Linux的文件系统中，一切实体被看作文件进行管理，不管是文件，目录，设备，管道等都被看作是文件。**

Linux文件系统会为每个文件分配两个数据结构:

- 索引节点(index node):
  - 即inode，用于记录文件的元信息，如编号，文件大小，访问权限，创建时间，修改时间，数据在磁盘中的位置等
  - 索引节点是文件的唯一标识，与文件一一对应
  - 索引节点与文件本身都存储在硬盘中
- 目录项(directory entry):
  - 用于记录文件名字，索引节点指针以及与其他目录项的层级关联关系
  - 多个目录项组合起来就会形成目录结构。
  - 目录项是由内核维护的一个数据结构，不存在在磁盘中，存在内存中，**避免对目录进行操作如`cd`访问磁盘，提高效率**

#### 目录项与目录的区别

目录项是内核在内存中维护的数据结构，相当于是目录结构的缓存，用来加速目录操作。

而目录在文件系统中被看作是文件，存储在硬盘中

#### 索引节点的目的

- 通过目录项找到文件索引节点，进而快速找到对应文件
- 存储文件元信息，便于读取

---

#### 磁盘

磁盘在linux的文件系统中也被视为文件处理，需要使用某磁盘数据时，需要对该磁盘进行挂载。

磁盘在linux中被格式化为3个部分

- 超级块：用来存储文件系统的详细信息，如块的个数，块的大小，空闲块等等
- 索引节点区：用于存储文件的索引节点
- 数据块区：用于存储数据

---

### 文件的存储

文件在磁盘中的存储方式主要有连续空间存放和非连续空间存放。

##### 连续空间存放

文件在磁盘中顺序存放，在这种模式下，文件都是按顺序存放在磁盘中，一次磁盘寻道就可以读出整个文件。

- 优点：读取效率高
- 缺点：
  - 存放时需要知道文件大小
  - 文件扩展难
  - 会产生空间碎片。因为文件只能占用连续的空间，存储的文件删除后，一般其他文件与其大小不同，存放进去之后可能有空间碎片产生，这些空间碎片大小不足以存储文件，就被浪费。

##### 非连续空间存放

即文件在磁盘中不要求连续存放。通过特殊的处理，让离散的存储最终读出文件。

非连续空间存放主要有链表方式和索引方式。

###### 链表方式

- 隐式链表存储
  - 在每个数据块中，空出一块用于存放指向下一个文件块的指针
  - 优点：
    - 离散存储，无空间碎片
    - 能够动态扩展
  - 缺点
    - 只能沿指针遍历读取，读取效率低
    - 指针丢失则文件损坏
- 显式链表存储
  - 把指向各个文件块的指针存放在链表里

###### 索引方式

链表方式虽然解决了磁盘碎片以及文件动态扩展问题，但是无法支持对文件块的直接访问。

索引的实现方式是为每个文件创建一个索引数据块，里面存放的是指向文件数据块的指针列表。

索引的方式优点在于：

- 文件的创建、增大、缩小很方便；
- 不会有碎片的问题；
- 支持顺序读写和随机读写；
- 且可以通过嵌套索引来支持大文件，只是多次读取索引会导致效率降低。



#### Unix 文件系统

![](https://markdown-1259282458.cos.ap-nanjing.myqcloud.com/img/20210816140513.png)

它是根据文件的大小，存放的方式会有所变化：

- 如果存放文件所需的数据块小于 10 块，则采用直接查找的方式；
- 如果存放文件所需的数据块超过 10 块，则采用一级间接索引方式；
- 如果前面两种方式都不够存放大文件，则采用二级间接索引方式；
- 如果二级间接索引也不够存放大文件，这采用三级间接索引方式；

那么，文件头（*Inode*）就需要包含 13 个指针：

- 10 个指向数据块的指针；
- 第 11 个指向索引块的指针；
- 第 12 个指向二级索引块的指针；
- 第 13 个指向三级索引块的指针；

---

### 空闲空间管理

常见的空闲空间管理方法主要分为

- 空闲表法
- 空闲链表法
- 位图法

#### 空闲表法

空闲表法就是为所有空闲空间建立一张表，存放空闲空间的第一个块号和该空闲区的块个数。(适用于连续分配)

![](https://markdown-1259282458.cos.ap-nanjing.myqcloud.com/img/20210816141132.png)

当需要分配空间时，就需要遍历空闲表，寻找合适的空间进行分配。回撤空间时也需要进行空间合并，也需要遍历空闲表。因此当管理空间过大，表项较多时，效率就会较低。不适用于大型文件系统。

#### 空闲链表

用链表将空闲块连接起来，当创建文件需要时，就依次取下几块即可。

#### 位图法

位图法是利用二进制的一位来表示磁盘中的一个盘块的使用情况，磁盘上所有的盘块都与一个二进制位对应。

Linux文件系统就采用位图来管理空间的空闲。

---

### 软链接与硬链接

硬链接是多个目录项中的指向索引节点的指针指向同一个索引节点

软链接是独立的文件，但是文件中存的是链接文件的路径。(相对路径)